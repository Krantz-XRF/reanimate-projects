<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Reanimate.Driver.Daemon</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Concurrent</span></span><span>
</span><span id="line-4"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span>         </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">E</span></span><span>
</span><span id="line-5"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-6"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Char8</span></span><span>     </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-7"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Network.Socket</span></span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Network.Socket.ByteString</span></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Reanimate.Driver.Server.html"><span class="hs-identifier">Reanimate.Driver.Server</span></a></span><span>   </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Server</span></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">System.FSNotify</span></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">System.FilePath</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">System.Environment</span></span><span>
</span><span id="line-13"></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Detach.html"><span class="hs-identifier">Detach</span></a></span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span class="hs-comment">{-
Main run message:

  Reanimate has gone into daemon mode and will block until you hit
  ctrl-c. While Reanimate is in daemon mode, you can open a new
  console or terminal and execute your animation code again. It'll
  automatically send the new animation to the browser window.

  Linux users can pass --daemon to reanimate to run the process in
  the background. Windows users have to use PowerShell and explicitly
  fork the process:
    Start-Process -NoNewWindow ./reanimate_exe

  Connection to the browser window will be lost if you hit ctrl-c.


Executing with daemon:
  Send animation to daemon and exit.
Executing without daemon:
  Run daemon locally.
  Render animation once.
  Wait without exiting.
  Detach if given --daemon flag. Only for Linux.

Executing on Linux:
  Running 'main' will start the daemon if it isn't already running.
  Then it'll render the animation and send it to the daemon.
  The daemon will open a browser window.
  Daemon stops after 30 minutes of inactivity.

Executing on Windows:
  'main' will act as daemon and not return.
  Powershell command for running in the background:
    Start-Process -NoNewWindow ./reanimate_exe

  Subsequent runs will send animation to daemon and quit.

In GHCi:
  Start local daemon thread if necessary.
  :cmd reanimateLive
    1. wait for changes
    2. &quot;:r&quot;
    3. &quot;:main&quot;
    4. &quot;:cmd Reanimate.reanimateLive&quot;



Web port: 9161
Daemon port: 9162?

-}</span><span>
</span><span id="line-67"></span><span>
</span><span id="line-68"></span><span class="hs-comment">{-
  Improvements over previous infrastructure:
  - Multiple browser windows can be open.
  - Browser window won't get stuck trying to open a connection.
  - GHCi is robust and works with both cabal and stack.
  - Refreshing the code will re-open closed browser windows.
-}</span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span class="hs-comment">-- | Load a reanimate program in GHCi and make sure 'main' is available.</span><span>
</span><span id="line-77"></span><span class="hs-comment">--   Then run:</span><span>
</span><span id="line-78"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-79"></span><span class="hs-comment">-- :cmd reanimateLive</span><span>
</span><span id="line-80"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-81"></span><span class="hs-comment">--</span><span>
</span><span id="line-82"></span><span class="hs-comment">-- This works by sending the commands ':r' and ':main' to your GHCi instance</span><span>
</span><span id="line-83"></span><span class="hs-comment">-- when any source file is changed.</span><span>
</span><span id="line-84"></span><span class="annot"><a href="Reanimate.Driver.Daemon.html#reanimateLive"><span class="hs-identifier hs-type">reanimateLive</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-85"></span><span id="reanimateLive"><span class="annot"><span class="annottext">reanimateLive :: IO String
</span><a href="Reanimate.Driver.Daemon.html#reanimateLive"><span class="hs-identifier hs-var hs-var">reanimateLive</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-86"></span><span>  </span><span class="annot"><span class="annottext">IO Bool -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">IO Bool
</span><a href="Reanimate.Driver.Daemon.html#ensureDaemon"><span class="hs-identifier hs-var">ensureDaemon</span></a></span><span>
</span><span id="line-87"></span><span>  </span><span id="local-6989586621679538794"><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621679538794"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO [String]
</span><span class="hs-identifier hs-var">getArgs</span></span><span>
</span><span id="line-88"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621679538794"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-89"></span><span>    </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;primed&quot;</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="Reanimate.Driver.Daemon.html#waitForChanges"><span class="hs-identifier hs-var">waitForChanges</span></a></span><span>
</span><span id="line-90"></span><span>    </span><span class="annot"><span class="annottext">[String]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-91"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; IO String
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO String) -&gt; String -&gt; IO String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; String
</span><span class="hs-identifier hs-var">unlines</span></span><span>
</span><span id="line-92"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;:r&quot;</span></span><span>
</span><span id="line-93"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;:main&quot;</span></span><span>
</span><span id="line-94"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;:cmd System.Environment.withArgs [\&quot;primed\&quot;] Reanimate.reanimateLive&quot;</span></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-95"></span><span>
</span><span id="line-96"></span><span class="hs-comment">-- | Load an animation in GHCi. Anything of type 'Animation' can be live reloaded.</span><span>
</span><span id="line-97"></span><span class="hs-comment">--</span><span>
</span><span id="line-98"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-99"></span><span class="hs-comment">-- :cmd reanimateLiveEntry &quot;drawCircle&quot;</span><span>
</span><span id="line-100"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-101"></span><span class="hs-comment">--</span><span>
</span><span id="line-102"></span><span class="hs-comment">-- This works by sending the commands ':r' and 'Reanimate.reanimate {entry}' to your</span><span>
</span><span id="line-103"></span><span class="hs-comment">-- GHCi instance when any source file is changed.</span><span>
</span><span id="line-104"></span><span class="annot"><a href="Reanimate.Driver.Daemon.html#reanimateLiveEntry"><span class="hs-identifier hs-type">reanimateLiveEntry</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-105"></span><span id="reanimateLiveEntry"><span class="annot"><span class="annottext">reanimateLiveEntry :: String -&gt; IO String
</span><a href="Reanimate.Driver.Daemon.html#reanimateLiveEntry"><span class="hs-identifier hs-var hs-var">reanimateLiveEntry</span></a></span></span><span> </span><span id="local-6989586621679538789"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679538789"><span class="hs-identifier hs-var">animation</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-106"></span><span>  </span><span class="annot"><span class="annottext">IO Bool -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">IO Bool
</span><a href="Reanimate.Driver.Daemon.html#ensureDaemon"><span class="hs-identifier hs-var">ensureDaemon</span></a></span><span>
</span><span id="line-107"></span><span>  </span><span id="local-6989586621679538788"><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621679538788"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO [String]
</span><span class="hs-identifier hs-var">getArgs</span></span><span>
</span><span id="line-108"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621679538788"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-109"></span><span>    </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;primed&quot;</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="Reanimate.Driver.Daemon.html#waitForChanges"><span class="hs-identifier hs-var">waitForChanges</span></a></span><span>
</span><span id="line-110"></span><span>    </span><span class="annot"><span class="annottext">[String]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; IO String
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO String) -&gt; String -&gt; IO String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; String
</span><span class="hs-identifier hs-var">unlines</span></span><span>
</span><span id="line-112"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;:r&quot;</span></span><span>
</span><span id="line-113"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Reanimate.reanimate (&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679538789"><span class="hs-identifier hs-var">animation</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;)&quot;</span></span><span>
</span><span id="line-114"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;:cmd System.Environment.withArgs [\&quot;primed\&quot;] (Reanimate.reanimateLiveEntry &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679538789"><span class="hs-identifier hs-var">animation</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;)&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-115"></span><span>
</span><span id="line-116"></span><span class="annot"><a href="Reanimate.Driver.Daemon.html#waitForChanges"><span class="hs-identifier hs-type">waitForChanges</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-117"></span><span id="waitForChanges"><span class="annot"><span class="annottext">waitForChanges :: IO ()
</span><a href="Reanimate.Driver.Daemon.html#waitForChanges"><span class="hs-identifier hs-var hs-var">waitForChanges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(WatchManager -&gt; IO ()) -&gt; IO ()
forall a. (WatchManager -&gt; IO a) -&gt; IO a
</span><span class="hs-identifier hs-var">withManager</span></span><span> </span><span class="annot"><span class="annottext">((WatchManager -&gt; IO ()) -&gt; IO ())
-&gt; (WatchManager -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679538785"><span class="annot"><span class="annottext">WatchManager
</span><a href="#local-6989586621679538785"><span class="hs-identifier hs-var">mgr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-118"></span><span>    </span><span id="local-6989586621679538784"><span class="annot"><span class="annottext">MVar ()
</span><a href="#local-6989586621679538784"><span class="hs-identifier hs-var">lock</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (MVar ())
forall a. IO (MVar a)
</span><span class="hs-identifier hs-var">newEmptyMVar</span></span><span>
</span><span id="line-119"></span><span>    </span><span id="local-6989586621679538782"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679538782"><span class="hs-identifier hs-var">stop</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WatchManager -&gt; String -&gt; ActionPredicate -&gt; Action -&gt; IO (IO ())
</span><span class="hs-identifier hs-var">watchTree</span></span><span> </span><span class="annot"><span class="annottext">WatchManager
</span><a href="#local-6989586621679538785"><span class="hs-identifier hs-var">mgr</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;.&quot;</span></span><span> </span><span class="annot"><span class="annottext">ActionPredicate
</span><a href="#local-6989586621679538780"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO () -&gt; Action
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; Action) -&gt; IO () -&gt; Action
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MVar () -&gt; () -&gt; IO ()
forall a. MVar a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">putMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar ()
</span><a href="#local-6989586621679538784"><span class="hs-identifier hs-var">lock</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-120"></span><span>    </span><span class="annot"><span class="annottext">MVar () -&gt; IO ()
forall a. MVar a -&gt; IO a
</span><span class="hs-identifier hs-var">takeMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar ()
</span><a href="#local-6989586621679538784"><span class="hs-identifier hs-var">lock</span></a></span><span>
</span><span id="line-121"></span><span>    </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679538782"><span class="hs-identifier hs-var">stop</span></a></span><span>
</span><span id="line-122"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-123"></span><span>    </span><span id="local-6989586621679538780"><span class="annot"><span class="annottext">check :: ActionPredicate
</span><a href="#local-6989586621679538780"><span class="hs-identifier hs-var hs-var">check</span></a></span></span><span> </span><span id="local-6989586621679538776"><span class="annot"><span class="annottext">Event
</span><a href="#local-6989586621679538776"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-124"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; String
</span><span class="hs-identifier hs-var">takeExtension</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Event -&gt; String
</span><span class="hs-identifier hs-var">eventPath</span></span><span> </span><span class="annot"><span class="annottext">Event
</span><a href="#local-6989586621679538776"><span class="hs-identifier hs-var">event</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String -&gt; [String] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621679538772"><span class="hs-identifier hs-var">sourceExtensions</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span>
</span><span id="line-125"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; String
</span><span class="hs-identifier hs-var">takeExtension</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Event -&gt; String
</span><span class="hs-identifier hs-var">eventPath</span></span><span> </span><span class="annot"><span class="annottext">Event
</span><a href="#local-6989586621679538776"><span class="hs-identifier hs-var">event</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String -&gt; [String] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621679538770"><span class="hs-identifier hs-var">dataExtensions</span></a></span><span>
</span><span id="line-126"></span><span>    </span><span id="local-6989586621679538772"><span class="annot"><span class="annottext">sourceExtensions :: [String]
</span><a href="#local-6989586621679538772"><span class="hs-identifier hs-var hs-var">sourceExtensions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;.hs&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;.lhs&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-127"></span><span>    </span><span id="local-6989586621679538770"><span class="annot"><span class="annottext">dataExtensions :: [String]
</span><a href="#local-6989586621679538770"><span class="hs-identifier hs-var hs-var">dataExtensions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;.jpg&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;.png&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;.bmp&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;.pov&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;.tex&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;.csv&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-128"></span><span>  </span><span>
</span><span id="line-129"></span><span>
</span><span id="line-130"></span><span class="hs-keyword">data</span><span> </span><span id="DaemonCommand"><span class="annot"><a href="Reanimate.Driver.Daemon.html#DaemonCommand"><span class="hs-identifier hs-var">DaemonCommand</span></a></span></span><span>
</span><span id="line-131"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="DaemonCount"><span class="annot"><a href="Reanimate.Driver.Daemon.html#DaemonCount"><span class="hs-identifier hs-var">DaemonCount</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-132"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="DaemonFrame"><span class="annot"><a href="Reanimate.Driver.Daemon.html#DaemonFrame"><span class="hs-identifier hs-var">DaemonFrame</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span>
</span><span id="line-133"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="DaemonStop"><span class="annot"><a href="Reanimate.Driver.Daemon.html#DaemonStop"><span class="hs-identifier hs-var">DaemonStop</span></a></span></span><span>
</span><span id="line-134"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679538760"><span id="local-6989586621679538762"><span id="local-6989586621679538764"><span class="annot"><span class="annottext">Int -&gt; DaemonCommand -&gt; String -&gt; String
[DaemonCommand] -&gt; String -&gt; String
DaemonCommand -&gt; String
(Int -&gt; DaemonCommand -&gt; String -&gt; String)
-&gt; (DaemonCommand -&gt; String)
-&gt; ([DaemonCommand] -&gt; String -&gt; String)
-&gt; Show DaemonCommand
forall a.
(Int -&gt; a -&gt; String -&gt; String)
-&gt; (a -&gt; String) -&gt; ([a] -&gt; String -&gt; String) -&gt; Show a
showList :: [DaemonCommand] -&gt; String -&gt; String
$cshowList :: [DaemonCommand] -&gt; String -&gt; String
show :: DaemonCommand -&gt; String
$cshow :: DaemonCommand -&gt; String
showsPrec :: Int -&gt; DaemonCommand -&gt; String -&gt; String
$cshowsPrec :: Int -&gt; DaemonCommand -&gt; String -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-135"></span><span>
</span><span id="line-136"></span><span class="annot"><a href="Reanimate.Driver.Daemon.html#sendCommand"><span class="hs-identifier hs-type">sendCommand</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Reanimate.Driver.Daemon.html#DaemonCommand"><span class="hs-identifier hs-type">DaemonCommand</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span id="sendCommand"><span class="annot"><span class="annottext">sendCommand :: DaemonCommand -&gt; IO ()
</span><a href="Reanimate.Driver.Daemon.html#sendCommand"><span class="hs-identifier hs-var hs-var">sendCommand</span></a></span></span><span> </span><span id="local-6989586621679538757"><span class="annot"><span class="annottext">DaemonCommand
</span><a href="#local-6989586621679538757"><span class="hs-identifier hs-var">cmd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO a
</span><span class="hs-identifier hs-var">withSocketsDo</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SomeException -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall e a. Exception e =&gt; (e -&gt; IO a) -&gt; IO a -&gt; IO a
</span><span class="hs-identifier hs-var">handle</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="hs-identifier hs-type">SomeException</span></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-138"></span><span>  </span><span id="local-6989586621679538753"><span class="annot"><span class="annottext">AddrInfo
</span><a href="#local-6989586621679538753"><span class="hs-identifier hs-var">addr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO AddrInfo
</span><a href="#local-6989586621679538752"><span class="hs-identifier hs-var">resolve</span></a></span><span>
</span><span id="line-139"></span><span>  </span><span class="annot"><span class="annottext">IO Socket -&gt; (Socket -&gt; IO ()) -&gt; (Socket -&gt; IO ()) -&gt; IO ()
forall a b c. IO a -&gt; (a -&gt; IO b) -&gt; (a -&gt; IO c) -&gt; IO c
</span><span class="hs-identifier hs-var">E.bracket</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AddrInfo -&gt; IO Socket
</span><a href="#local-6989586621679538750"><span class="hs-identifier hs-var">open</span></a></span><span> </span><span class="annot"><span class="annottext">AddrInfo
</span><a href="#local-6989586621679538753"><span class="hs-identifier hs-var">addr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Socket -&gt; IO ()
</span><span class="hs-identifier hs-var">close</span></span><span> </span><span class="annot"><span class="annottext">((Socket -&gt; IO ()) -&gt; IO ()) -&gt; (Socket -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679538748"><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679538748"><span class="hs-identifier hs-var">sock</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-140"></span><span>    </span><span class="annot"><span class="annottext">IO Int -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(IO Int -&gt; IO ()) -&gt; IO Int -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Socket -&gt; ByteString -&gt; IO Int
</span><span class="hs-identifier hs-var">send</span></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679538748"><span class="hs-identifier hs-var">sock</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; IO Int) -&gt; ByteString -&gt; IO Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DaemonCommand
</span><a href="#local-6989586621679538757"><span class="hs-identifier hs-var">cmd</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-141"></span><span>      </span><span class="annot"><a href="Reanimate.Driver.Daemon.html#DaemonCount"><span class="hs-identifier hs-type">DaemonCount</span></a></span><span> </span><span id="local-6989586621679538746"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679538746"><span class="hs-identifier hs-var">count</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; ByteString
</span><span class="hs-identifier hs-var">BS.pack</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; ByteString) -&gt; String -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; String
</span><span class="hs-identifier hs-var">unwords</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;frame_count&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679538746"><span class="hs-identifier hs-var">count</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-142"></span><span>      </span><span class="annot"><a href="Reanimate.Driver.Daemon.html#DaemonFrame"><span class="hs-identifier hs-type">DaemonFrame</span></a></span><span> </span><span id="local-6989586621679538743"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679538743"><span class="hs-identifier hs-var">nth</span></a></span></span><span> </span><span id="local-6989586621679538742"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679538742"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; ByteString
</span><span class="hs-identifier hs-var">BS.pack</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; ByteString) -&gt; String -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; String
</span><span class="hs-identifier hs-var">unwords</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;frame&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679538743"><span class="hs-identifier hs-var">nth</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679538742"><span class="hs-identifier hs-var">path</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-143"></span><span>      </span><span class="annot"><span class="annottext">DaemonCommand
</span><a href="Reanimate.Driver.Daemon.html#DaemonStop"><span class="hs-identifier hs-var">DaemonStop</span></a></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; ByteString
</span><span class="hs-identifier hs-var">BS.pack</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; ByteString) -&gt; String -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; String
</span><span class="hs-identifier hs-var">unwords</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;stop&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-144"></span><span>    </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-145"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-146"></span><span>    </span><span id="local-6989586621679538752"><span class="annot"><span class="annottext">resolve :: IO AddrInfo
</span><a href="#local-6989586621679538752"><span class="hs-identifier hs-var hs-var">resolve</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-147"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679538741"><span class="annot"><span class="annottext">hints :: AddrInfo
</span><a href="#local-6989586621679538741"><span class="hs-identifier hs-var hs-var">hints</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AddrInfo
</span><span class="hs-identifier hs-var">defaultHints</span></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">addrSocketType :: SocketType
</span><span class="hs-identifier hs-var">addrSocketType</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SocketType
</span><span class="hs-identifier hs-var">Stream</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-148"></span><span>        </span><span class="annot"><span class="annottext">[AddrInfo] -&gt; AddrInfo
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">head</span></span><span> </span><span class="annot"><span class="annottext">([AddrInfo] -&gt; AddrInfo) -&gt; IO [AddrInfo] -&gt; IO AddrInfo
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe AddrInfo -&gt; Maybe String -&gt; Maybe String -&gt; IO [AddrInfo]
</span><span class="hs-identifier hs-var">getAddrInfo</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AddrInfo -&gt; Maybe AddrInfo
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">AddrInfo
</span><a href="#local-6989586621679538741"><span class="hs-identifier hs-var">hints</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Maybe String
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;127.0.0.1&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Maybe String
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;9162&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-149"></span><span>    </span><span id="local-6989586621679538750"><span class="annot"><span class="annottext">open :: AddrInfo -&gt; IO Socket
</span><a href="#local-6989586621679538750"><span class="hs-identifier hs-var hs-var">open</span></a></span></span><span> </span><span id="local-6989586621679538734"><span class="annot"><span class="annottext">AddrInfo
</span><a href="#local-6989586621679538734"><span class="hs-identifier hs-var">addr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO Socket
-&gt; (Socket -&gt; IO ()) -&gt; (Socket -&gt; IO Socket) -&gt; IO Socket
forall a b c. IO a -&gt; (a -&gt; IO b) -&gt; (a -&gt; IO c) -&gt; IO c
</span><span class="hs-identifier hs-var">E.bracketOnError</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AddrInfo -&gt; IO Socket
</span><a href="Reanimate.Driver.Daemon.html#oSocket"><span class="hs-identifier hs-var">oSocket</span></a></span><span> </span><span class="annot"><span class="annottext">AddrInfo
</span><a href="#local-6989586621679538734"><span class="hs-identifier hs-var">addr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Socket -&gt; IO ()
</span><span class="hs-identifier hs-var">close</span></span><span> </span><span class="annot"><span class="annottext">((Socket -&gt; IO Socket) -&gt; IO Socket)
-&gt; (Socket -&gt; IO Socket) -&gt; IO Socket
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679538731"><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679538731"><span class="hs-identifier hs-var">sock</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-150"></span><span>      </span><span class="annot"><span class="annottext">Socket -&gt; SockAddr -&gt; IO ()
</span><span class="hs-identifier hs-var">connect</span></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679538731"><span class="hs-identifier hs-var">sock</span></a></span><span> </span><span class="annot"><span class="annottext">(SockAddr -&gt; IO ()) -&gt; SockAddr -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">AddrInfo -&gt; SockAddr
</span><span class="hs-identifier hs-var hs-var">addrAddress</span></span><span> </span><span class="annot"><span class="annottext">AddrInfo
</span><a href="#local-6989586621679538734"><span class="hs-identifier hs-var">addr</span></a></span><span>
</span><span id="line-151"></span><span>      </span><span class="annot"><span class="annottext">Socket -&gt; IO Socket
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679538731"><span class="hs-identifier hs-var">sock</span></a></span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span class="annot"><a href="Reanimate.Driver.Daemon.html#hasDaemon"><span class="hs-identifier hs-type">hasDaemon</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-154"></span><span id="hasDaemon"><span class="annot"><span class="annottext">hasDaemon :: IO Bool
</span><a href="Reanimate.Driver.Daemon.html#hasDaemon"><span class="hs-identifier hs-var hs-var">hasDaemon</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO Bool -&gt; IO Bool
forall a. IO a -&gt; IO a
</span><span class="hs-identifier hs-var">withSocketsDo</span></span><span> </span><span class="annot"><span class="annottext">(IO Bool -&gt; IO Bool) -&gt; IO Bool -&gt; IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SomeException -&gt; IO Bool) -&gt; IO Bool -&gt; IO Bool
forall e a. Exception e =&gt; (e -&gt; IO a) -&gt; IO a -&gt; IO a
</span><span class="hs-identifier hs-var">handle</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="hs-identifier hs-type">SomeException</span></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO Bool -&gt; IO Bool) -&gt; IO Bool -&gt; IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-155"></span><span>  </span><span id="local-6989586621679538727"><span class="annot"><span class="annottext">AddrInfo
</span><a href="#local-6989586621679538727"><span class="hs-identifier hs-var">addr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO AddrInfo
</span><a href="#local-6989586621679538726"><span class="hs-identifier hs-var">resolve</span></a></span><span>
</span><span id="line-156"></span><span>  </span><span class="annot"><span class="annottext">IO Socket -&gt; (Socket -&gt; IO ()) -&gt; (Socket -&gt; IO Bool) -&gt; IO Bool
forall a b c. IO a -&gt; (a -&gt; IO b) -&gt; (a -&gt; IO c) -&gt; IO c
</span><span class="hs-identifier hs-var">E.bracket</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AddrInfo -&gt; IO Socket
</span><a href="#local-6989586621679538725"><span class="hs-identifier hs-var">open</span></a></span><span> </span><span class="annot"><span class="annottext">AddrInfo
</span><a href="#local-6989586621679538727"><span class="hs-identifier hs-var">addr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Socket -&gt; IO ()
</span><span class="hs-identifier hs-var">close</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO Bool -&gt; Socket -&gt; IO Bool
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">(IO Bool -&gt; Socket -&gt; IO Bool) -&gt; IO Bool -&gt; Socket -&gt; IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>
</span><span id="line-157"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-158"></span><span>    </span><span id="local-6989586621679538726"><span class="annot"><span class="annottext">resolve :: IO AddrInfo
</span><a href="#local-6989586621679538726"><span class="hs-identifier hs-var hs-var">resolve</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-159"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679538724"><span class="annot"><span class="annottext">hints :: AddrInfo
</span><a href="#local-6989586621679538724"><span class="hs-identifier hs-var hs-var">hints</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AddrInfo
</span><span class="hs-identifier hs-var">defaultHints</span></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">addrSocketType :: SocketType
</span><span class="hs-identifier hs-var">addrSocketType</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SocketType
</span><span class="hs-identifier hs-var">Stream</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-160"></span><span>        </span><span class="annot"><span class="annottext">[AddrInfo] -&gt; AddrInfo
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">head</span></span><span> </span><span class="annot"><span class="annottext">([AddrInfo] -&gt; AddrInfo) -&gt; IO [AddrInfo] -&gt; IO AddrInfo
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe AddrInfo -&gt; Maybe String -&gt; Maybe String -&gt; IO [AddrInfo]
</span><span class="hs-identifier hs-var">getAddrInfo</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AddrInfo -&gt; Maybe AddrInfo
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">AddrInfo
</span><a href="#local-6989586621679538724"><span class="hs-identifier hs-var">hints</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Maybe String
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;127.0.0.1&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Maybe String
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;9162&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-161"></span><span>    </span><span id="local-6989586621679538725"><span class="annot"><span class="annottext">open :: AddrInfo -&gt; IO Socket
</span><a href="#local-6989586621679538725"><span class="hs-identifier hs-var hs-var">open</span></a></span></span><span> </span><span id="local-6989586621679538723"><span class="annot"><span class="annottext">AddrInfo
</span><a href="#local-6989586621679538723"><span class="hs-identifier hs-var">addr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO Socket
-&gt; (Socket -&gt; IO ()) -&gt; (Socket -&gt; IO Socket) -&gt; IO Socket
forall a b c. IO a -&gt; (a -&gt; IO b) -&gt; (a -&gt; IO c) -&gt; IO c
</span><span class="hs-identifier hs-var">E.bracketOnError</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AddrInfo -&gt; IO Socket
</span><a href="Reanimate.Driver.Daemon.html#oSocket"><span class="hs-identifier hs-var">oSocket</span></a></span><span> </span><span class="annot"><span class="annottext">AddrInfo
</span><a href="#local-6989586621679538723"><span class="hs-identifier hs-var">addr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Socket -&gt; IO ()
</span><span class="hs-identifier hs-var">close</span></span><span> </span><span class="annot"><span class="annottext">((Socket -&gt; IO Socket) -&gt; IO Socket)
-&gt; (Socket -&gt; IO Socket) -&gt; IO Socket
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679538722"><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679538722"><span class="hs-identifier hs-var">sock</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-162"></span><span>      </span><span class="annot"><span class="annottext">Socket -&gt; SockAddr -&gt; IO ()
</span><span class="hs-identifier hs-var">connect</span></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679538722"><span class="hs-identifier hs-var">sock</span></a></span><span> </span><span class="annot"><span class="annottext">(SockAddr -&gt; IO ()) -&gt; SockAddr -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">AddrInfo -&gt; SockAddr
</span><span class="hs-identifier hs-var hs-var">addrAddress</span></span><span> </span><span class="annot"><span class="annottext">AddrInfo
</span><a href="#local-6989586621679538723"><span class="hs-identifier hs-var">addr</span></a></span><span>
</span><span id="line-163"></span><span>      </span><span class="annot"><span class="annottext">Socket -&gt; IO Socket
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621679538722"><span class="hs-identifier hs-var">sock</span></a></span><span>
</span><span id="line-164"></span><span>
</span><span id="line-165"></span><span class="annot"><a href="Reanimate.Driver.Daemon.html#oSocket"><span class="hs-identifier hs-type">oSocket</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AddrInfo</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket</span></span><span>
</span><span id="line-166"></span><span id="oSocket"><span class="annot"><span class="annottext">oSocket :: AddrInfo -&gt; IO Socket
</span><a href="Reanimate.Driver.Daemon.html#oSocket"><span class="hs-identifier hs-var hs-var">oSocket</span></a></span></span><span> </span><span id="local-6989586621679538721"><span class="annot"><span class="annottext">AddrInfo
</span><a href="#local-6989586621679538721"><span class="hs-identifier hs-var">addr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Family -&gt; SocketType -&gt; ProtocolNumber -&gt; IO Socket
</span><span class="hs-identifier hs-var">socket</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AddrInfo -&gt; Family
</span><span class="hs-identifier hs-var hs-var">addrFamily</span></span><span> </span><span class="annot"><span class="annottext">AddrInfo
</span><a href="#local-6989586621679538721"><span class="hs-identifier hs-var">addr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AddrInfo -&gt; SocketType
</span><span class="hs-identifier hs-var hs-var">addrSocketType</span></span><span> </span><span class="annot"><span class="annottext">AddrInfo
</span><a href="#local-6989586621679538721"><span class="hs-identifier hs-var">addr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AddrInfo -&gt; ProtocolNumber
</span><span class="hs-identifier hs-var hs-var">addrProtocol</span></span><span> </span><span class="annot"><span class="annottext">AddrInfo
</span><a href="#local-6989586621679538721"><span class="hs-identifier hs-var">addr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-167"></span><span>
</span><span id="line-168"></span><span class="annot"><a href="Reanimate.Driver.Daemon.html#ensureDaemon"><span class="hs-identifier hs-type">ensureDaemon</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-169"></span><span id="ensureDaemon"><span class="annot"><span class="annottext">ensureDaemon :: IO Bool
</span><a href="Reanimate.Driver.Daemon.html#ensureDaemon"><span class="hs-identifier hs-var hs-var">ensureDaemon</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-170"></span><span>  </span><span id="local-6989586621679538717"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679538717"><span class="hs-identifier hs-var">daemon</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Bool
</span><a href="Reanimate.Driver.Daemon.html#hasDaemon"><span class="hs-identifier hs-var">hasDaemon</span></a></span><span>
</span><span id="line-171"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679538717"><span class="hs-identifier hs-var">daemon</span></a></span><span>
</span><span id="line-172"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-173"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">IO Bool
</span><a href="Reanimate.Driver.Daemon.html#localDaemon"><span class="hs-identifier hs-var">localDaemon</span></a></span><span>
</span><span id="line-174"></span><span>
</span><span id="line-175"></span><span class="annot"><a href="Reanimate.Driver.Daemon.html#killDaemon"><span class="hs-identifier hs-type">killDaemon</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span id="killDaemon"><span class="annot"><span class="annottext">killDaemon :: IO ()
</span><a href="Reanimate.Driver.Daemon.html#killDaemon"><span class="hs-identifier hs-var hs-var">killDaemon</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DaemonCommand -&gt; IO ()
</span><a href="Reanimate.Driver.Daemon.html#sendCommand"><span class="hs-identifier hs-var">sendCommand</span></a></span><span> </span><span class="annot"><span class="annottext">DaemonCommand
</span><a href="Reanimate.Driver.Daemon.html#DaemonStop"><span class="hs-identifier hs-var">DaemonStop</span></a></span><span>
</span><span id="line-177"></span><span>
</span><span id="line-178"></span><span class="annot"><a href="Reanimate.Driver.Daemon.html#localDaemon"><span class="hs-identifier hs-type">localDaemon</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-179"></span><span id="localDaemon"><span class="annot"><span class="annottext">localDaemon :: IO Bool
</span><a href="Reanimate.Driver.Daemon.html#localDaemon"><span class="hs-identifier hs-var hs-var">localDaemon</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-180"></span><span>  </span><span class="annot"><span class="annottext">IO ()
</span><a href="Reanimate.Driver.Daemon.html#killDaemon"><span class="hs-identifier hs-var">killDaemon</span></a></span><span>
</span><span id="line-181"></span><span>  </span><span class="annot"><span class="annottext">IO () -&gt; IO Bool
</span><a href="Detach.html#detach"><span class="hs-identifier hs-var">detach</span></a></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="Reanimate.Driver.Server.html#daemon"><span class="hs-identifier hs-var">Server.daemon</span></a></span><span>
</span><span id="line-182"></span><span>
</span><span id="line-183"></span></pre></body></html>