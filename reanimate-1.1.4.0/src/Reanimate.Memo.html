<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns              #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE ExistentialQuantification #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes                #-}</span><span>
</span><span id="line-4"></span><span class="hs-comment">{-|
Copyright   : Written by David Himmelstrup
License     : Unlicense
Maintainer  : lemmih@gmail.com
Stability   : experimental
Portability : POSIX

With animations defined as SVG images over time, it is unfortunately
quite easy to write inefficient code where expensive expressions are
re-evaluated for every frame even if nothing has changed. This get
around this issue, this module defines a global key-value table that
can store expensive expressions such that they are evaluated only once.

There is currently no way to clear values from the table and it is your
own responsibility to not consume all available memory.

-}</span><span>
</span><span id="line-21"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Reanimate.Memo</span><span>
</span><span id="line-22"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Reanimate.Memo.html#Key"><span class="hs-identifier">Key</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Reanimate.Memo.html#memo"><span class="hs-identifier">memo</span></a></span><span>
</span><span id="line-24"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Dynamic</span></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Dynamic</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">fromDynamic</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">toDyn</span></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.IORef</span></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">IORef</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">atomicModifyIORef'</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">newIORef</span></span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span>              </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">fromMaybe</span></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Typeable</span></span><span>         </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Typeable</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">cast</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">typeOf</span></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">System.IO.Unsafe</span></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">unsafePerformIO</span></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">System.Mem.StableName</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">StableName</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">eqStableName</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">hashStableName</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">makeStableName</span></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span>
</span><span id="line-34"></span><span class="hs-keyword">data</span><span> </span><span id="DynamicName"><span class="annot"><a href="Reanimate.Memo.html#DynamicName"><span class="hs-identifier hs-var">DynamicName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679540661"><span class="annot"><a href="#local-6989586621679540661"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span id="DynamicName"><span class="annot"><a href="Reanimate.Memo.html#DynamicName"><span class="hs-identifier hs-var">DynamicName</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StableName</span></span><span> </span><span class="annot"><a href="#local-6989586621679540661"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679540653"><span class="annot"><a href="#local-6989586621679540653"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621679540653"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679540653"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Typeable</span></span><span> </span><span class="annot"><a href="#local-6989586621679540653"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span id="DynamicKey"><span class="annot"><a href="Reanimate.Memo.html#DynamicKey"><span class="hs-identifier hs-var">DynamicKey</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679540653"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679540625"><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="Reanimate.Memo.html#DynamicName"><span class="hs-identifier hs-type">DynamicName</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-36"></span><span>  </span><span class="annot"><a href="Reanimate.Memo.html#DynamicName"><span class="hs-identifier hs-type">DynamicName</span></a></span><span> </span><span id="local-6989586621679540623"><span class="annot"><span class="annottext">StableName a
</span><a href="#local-6989586621679540623"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679540622"><span class="annot"><span class="annottext">== :: DynamicName -&gt; DynamicName -&gt; Bool
</span><span class="hs-operator hs-var hs-var hs-var hs-var">==</span></span></span><span> </span><span class="annot"><a href="Reanimate.Memo.html#DynamicName"><span class="hs-identifier hs-type">DynamicName</span></a></span><span> </span><span id="local-6989586621679540621"><span class="annot"><span class="annottext">StableName a
</span><a href="#local-6989586621679540621"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StableName a -&gt; StableName a -&gt; Bool
forall a b. StableName a -&gt; StableName b -&gt; Bool
</span><span class="hs-identifier hs-var">eqStableName</span></span><span> </span><span class="annot"><span class="annottext">StableName a
</span><a href="#local-6989586621679540623"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">StableName a
</span><a href="#local-6989586621679540621"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-37"></span><span>  </span><span class="annot"><a href="Reanimate.Memo.html#DynamicKey"><span class="hs-identifier hs-type">DynamicKey</span></a></span><span> </span><span id="local-6989586621679540620"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679540620"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><a href="Reanimate.Memo.html#DynamicKey"><span class="hs-identifier hs-type">DynamicKey</span></a></span><span> </span><span id="local-6989586621679540619"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679540619"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-38"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a b. (Typeable a, Typeable b) =&gt; a -&gt; Maybe b
</span><span class="hs-identifier hs-var">cast</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679540620"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-39"></span><span>      </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-40"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679540618"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679540618"><span class="hs-identifier hs-var">a'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679540618"><span class="hs-identifier hs-var">a'</span></a></span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679540619"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-41"></span><span>  </span><span class="annot"><span class="annottext">DynamicName
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">DynamicName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679540604"><span id="local-6989586621679540606"><span id="local-6989586621679540608"><span id="local-6989586621679540610"><span id="local-6989586621679540612"><span id="local-6989586621679540614"><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="Reanimate.Memo.html#DynamicName"><span class="hs-identifier hs-type">DynamicName</span></a></span></span></span></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-44"></span><span>  </span><span class="annot"><a href="Reanimate.Memo.html#DynamicName"><span class="hs-identifier hs-type">DynamicName</span></a></span><span> </span><span id="local-6989586621679540602"><span class="annot"><span class="annottext">StableName a
</span><a href="#local-6989586621679540602"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679540601"><span class="annot"><span class="annottext">compare :: DynamicName -&gt; DynamicName -&gt; Ordering
</span><span class="hs-operator hs-var hs-var hs-var hs-var">`compare`</span></span></span><span> </span><span class="annot"><a href="Reanimate.Memo.html#DynamicName"><span class="hs-identifier hs-type">DynamicName</span></a></span><span> </span><span id="local-6989586621679540599"><span class="annot"><span class="annottext">StableName a
</span><a href="#local-6989586621679540599"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-45"></span><span>    </span><span class="annot"><span class="annottext">StableName a -&gt; Int
forall a. StableName a -&gt; Int
</span><span class="hs-identifier hs-var">hashStableName</span></span><span> </span><span class="annot"><span class="annottext">StableName a
</span><a href="#local-6989586621679540602"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Ordering
forall a. Ord a =&gt; a -&gt; a -&gt; Ordering
</span><span class="hs-operator hs-var">`compare`</span></span><span> </span><span class="annot"><span class="annottext">StableName a -&gt; Int
forall a. StableName a -&gt; Int
</span><span class="hs-identifier hs-var">hashStableName</span></span><span> </span><span class="annot"><span class="annottext">StableName a
</span><a href="#local-6989586621679540599"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-46"></span><span>  </span><span class="annot"><a href="Reanimate.Memo.html#DynamicName"><span class="hs-identifier hs-type">DynamicName</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="annot"><span class="hs-operator hs-var">`compare`</span></span><span> </span><span class="annot"><span class="annottext">DynamicName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">LT</span></span><span>
</span><span id="line-47"></span><span>  </span><span class="annot"><a href="Reanimate.Memo.html#DynamicKey"><span class="hs-identifier hs-type">DynamicKey</span></a></span><span> </span><span id="local-6989586621679540598"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679540598"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-var">`compare`</span></span><span> </span><span class="annot"><a href="Reanimate.Memo.html#DynamicKey"><span class="hs-identifier hs-type">DynamicKey</span></a></span><span> </span><span id="local-6989586621679540597"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679540597"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-48"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a b. (Typeable a, Typeable b) =&gt; a -&gt; Maybe b
</span><span class="hs-identifier hs-var">cast</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679540598"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-49"></span><span>      </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; TypeRep
forall a. Typeable a =&gt; a -&gt; TypeRep
</span><span class="hs-identifier hs-var">typeOf</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679540598"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">TypeRep -&gt; TypeRep -&gt; Ordering
forall a. Ord a =&gt; a -&gt; a -&gt; Ordering
</span><span class="hs-operator hs-var">`compare`</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; TypeRep
forall a. Typeable a =&gt; a -&gt; TypeRep
</span><span class="hs-identifier hs-var">typeOf</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679540597"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-50"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679540596"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679540596"><span class="hs-identifier hs-var">a'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679540596"><span class="hs-identifier hs-var">a'</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Ordering
forall a. Ord a =&gt; a -&gt; a -&gt; Ordering
</span><span class="hs-operator hs-var">`compare`</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679540597"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-51"></span><span>  </span><span class="annot"><span class="annottext">DynamicName
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-operator hs-var">`compare`</span></span><span> </span><span class="annot"><span class="annottext">DynamicName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">GT</span></span><span>
</span><span id="line-52"></span><span>
</span><span id="line-53"></span><span class="hs-keyword">data</span><span> </span><span id="CacheMap"><span class="annot"><a href="Reanimate.Memo.html#CacheMap"><span class="hs-identifier hs-var">CacheMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="CacheMap"><span class="annot"><a href="Reanimate.Memo.html#CacheMap"><span class="hs-identifier hs-var">CacheMap</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map.Map</span></span><span> </span><span class="annot"><a href="Reanimate.Memo.html#DynamicName"><span class="hs-identifier hs-type">DynamicName</span></a></span><span> </span><span class="annot"><a href="Reanimate.Memo.html#CacheMap"><span class="hs-identifier hs-type">CacheMap</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map.Map</span></span><span> </span><span class="annot"><a href="Reanimate.Memo.html#DynamicName"><span class="hs-identifier hs-type">DynamicName</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Dynamic</span></span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span class="annot"><a href="Reanimate.Memo.html#emptyCacheMap"><span class="hs-identifier hs-type">emptyCacheMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Reanimate.Memo.html#CacheMap"><span class="hs-identifier hs-type">CacheMap</span></a></span><span>
</span><span id="line-56"></span><span id="emptyCacheMap"><span class="annot"><span class="annottext">emptyCacheMap :: CacheMap
</span><a href="Reanimate.Memo.html#emptyCacheMap"><span class="hs-identifier hs-var hs-var">emptyCacheMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map DynamicName CacheMap -&gt; Map DynamicName Dynamic -&gt; CacheMap
</span><a href="Reanimate.Memo.html#CacheMap"><span class="hs-identifier hs-var">CacheMap</span></a></span><span> </span><span class="annot"><span class="annottext">Map DynamicName CacheMap
forall k a. Map k a
</span><span class="hs-identifier hs-var">Map.empty</span></span><span> </span><span class="annot"><span class="annottext">Map DynamicName Dynamic
forall k a. Map k a
</span><span class="hs-identifier hs-var">Map.empty</span></span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span class="hs-comment">-- sizeCacheMap :: CacheMap -&gt; Int</span><span>
</span><span id="line-59"></span><span class="hs-comment">-- sizeCacheMap (CacheMap sub vals) =</span><span>
</span><span id="line-60"></span><span class="hs-comment">--   sum (map sizeCacheMap (Map.elems sub)) + Map.size vals</span><span>
</span><span id="line-61"></span><span>
</span><span id="line-62"></span><span class="annot"><a href="Reanimate.Memo.html#cacheMapLookup"><span class="hs-identifier hs-type">cacheMapLookup</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Reanimate.Memo.html#DynamicName"><span class="hs-identifier hs-type">DynamicName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Reanimate.Memo.html#CacheMap"><span class="hs-identifier hs-type">CacheMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Dynamic</span></span><span>
</span><span id="line-63"></span><span id="cacheMapLookup"><span class="annot"><span class="annottext">cacheMapLookup :: [DynamicName] -&gt; CacheMap -&gt; Maybe Dynamic
</span><a href="Reanimate.Memo.html#cacheMapLookup"><span class="hs-identifier hs-var hs-var">cacheMapLookup</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">CacheMap
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Dynamic
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-64"></span><span class="annot"><a href="Reanimate.Memo.html#cacheMapLookup"><span class="hs-identifier hs-var">cacheMapLookup</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679540591"><span class="annot"><span class="annottext">DynamicName
</span><a href="#local-6989586621679540591"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Reanimate.Memo.html#CacheMap"><span class="hs-identifier hs-type">CacheMap</span></a></span><span> </span><span class="annot"><span class="annottext">Map DynamicName CacheMap
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679540590"><span class="annot"><span class="annottext">Map DynamicName Dynamic
</span><a href="#local-6989586621679540590"><span class="hs-identifier hs-var">vals</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynamicName -&gt; Map DynamicName Dynamic -&gt; Maybe Dynamic
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">DynamicName
</span><a href="#local-6989586621679540591"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Map DynamicName Dynamic
</span><a href="#local-6989586621679540590"><span class="hs-identifier hs-var">vals</span></a></span><span>
</span><span id="line-65"></span><span class="annot"><a href="Reanimate.Memo.html#cacheMapLookup"><span class="hs-identifier hs-var">cacheMapLookup</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679540588"><span class="annot"><span class="annottext">DynamicName
</span><a href="#local-6989586621679540588"><span class="hs-identifier hs-var">k</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679540587"><span class="annot"><span class="annottext">[DynamicName]
</span><a href="#local-6989586621679540587"><span class="hs-identifier hs-var">ks</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Reanimate.Memo.html#CacheMap"><span class="hs-identifier hs-type">CacheMap</span></a></span><span> </span><span id="local-6989586621679540586"><span class="annot"><span class="annottext">Map DynamicName CacheMap
</span><a href="#local-6989586621679540586"><span class="hs-identifier hs-var">sub</span></a></span></span><span> </span><span class="annot"><span class="annottext">Map DynamicName Dynamic
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-66"></span><span>  </span><span class="annot"><span class="annottext">[DynamicName] -&gt; CacheMap -&gt; Maybe Dynamic
</span><a href="Reanimate.Memo.html#cacheMapLookup"><span class="hs-identifier hs-var">cacheMapLookup</span></a></span><span> </span><span class="annot"><span class="annottext">[DynamicName]
</span><a href="#local-6989586621679540587"><span class="hs-identifier hs-var">ks</span></a></span><span> </span><span class="annot"><span class="annottext">(CacheMap -&gt; Maybe Dynamic) -&gt; Maybe CacheMap -&gt; Maybe Dynamic
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">DynamicName -&gt; Map DynamicName CacheMap -&gt; Maybe CacheMap
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">DynamicName
</span><a href="#local-6989586621679540588"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Map DynamicName CacheMap
</span><a href="#local-6989586621679540586"><span class="hs-identifier hs-var">sub</span></a></span><span>
</span><span id="line-67"></span><span>
</span><span id="line-68"></span><span class="annot"><a href="Reanimate.Memo.html#cacheMapInsert"><span class="hs-identifier hs-type">cacheMapInsert</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Reanimate.Memo.html#DynamicName"><span class="hs-identifier hs-type">DynamicName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Dynamic</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Reanimate.Memo.html#CacheMap"><span class="hs-identifier hs-type">CacheMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Reanimate.Memo.html#CacheMap"><span class="hs-identifier hs-type">CacheMap</span></a></span><span>
</span><span id="line-69"></span><span id="cacheMapInsert"><span class="annot"><span class="annottext">cacheMapInsert :: [DynamicName] -&gt; Dynamic -&gt; CacheMap -&gt; CacheMap
</span><a href="Reanimate.Memo.html#cacheMapInsert"><span class="hs-identifier hs-var hs-var">cacheMapInsert</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Dynamic
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679540583"><span class="annot"><span class="annottext">CacheMap
</span><a href="#local-6989586621679540583"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CacheMap
</span><a href="#local-6989586621679540583"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-70"></span><span class="annot"><a href="Reanimate.Memo.html#cacheMapInsert"><span class="hs-identifier hs-var">cacheMapInsert</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679540582"><span class="annot"><span class="annottext">DynamicName
</span><a href="#local-6989586621679540582"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621679540581"><span class="annot"><span class="annottext">Dynamic
</span><a href="#local-6989586621679540581"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Reanimate.Memo.html#CacheMap"><span class="hs-identifier hs-type">CacheMap</span></a></span><span> </span><span id="local-6989586621679540580"><span class="annot"><span class="annottext">Map DynamicName CacheMap
</span><a href="#local-6989586621679540580"><span class="hs-identifier hs-var">sub</span></a></span></span><span> </span><span id="local-6989586621679540579"><span class="annot"><span class="annottext">Map DynamicName Dynamic
</span><a href="#local-6989586621679540579"><span class="hs-identifier hs-var">vals</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map DynamicName CacheMap -&gt; Map DynamicName Dynamic -&gt; CacheMap
</span><a href="Reanimate.Memo.html#CacheMap"><span class="hs-identifier hs-var">CacheMap</span></a></span><span> </span><span class="annot"><span class="annottext">Map DynamicName CacheMap
</span><a href="#local-6989586621679540580"><span class="hs-identifier hs-var">sub</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DynamicName
-&gt; Dynamic -&gt; Map DynamicName Dynamic -&gt; Map DynamicName Dynamic
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.insert</span></span><span> </span><span class="annot"><span class="annottext">DynamicName
</span><a href="#local-6989586621679540582"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Dynamic
</span><a href="#local-6989586621679540581"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Map DynamicName Dynamic
</span><a href="#local-6989586621679540579"><span class="hs-identifier hs-var">vals</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span class="annot"><a href="Reanimate.Memo.html#cacheMapInsert"><span class="hs-identifier hs-var">cacheMapInsert</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679540577"><span class="annot"><span class="annottext">DynamicName
</span><a href="#local-6989586621679540577"><span class="hs-identifier hs-var">k</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679540576"><span class="annot"><span class="annottext">[DynamicName]
</span><a href="#local-6989586621679540576"><span class="hs-identifier hs-var">ks</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679540575"><span class="annot"><span class="annottext">Dynamic
</span><a href="#local-6989586621679540575"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Reanimate.Memo.html#CacheMap"><span class="hs-identifier hs-type">CacheMap</span></a></span><span> </span><span id="local-6989586621679540574"><span class="annot"><span class="annottext">Map DynamicName CacheMap
</span><a href="#local-6989586621679540574"><span class="hs-identifier hs-var">sub</span></a></span></span><span> </span><span id="local-6989586621679540573"><span class="annot"><span class="annottext">Map DynamicName Dynamic
</span><a href="#local-6989586621679540573"><span class="hs-identifier hs-var">vals</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-72"></span><span>  </span><span class="annot"><span class="annottext">Map DynamicName CacheMap -&gt; Map DynamicName Dynamic -&gt; CacheMap
</span><a href="Reanimate.Memo.html#CacheMap"><span class="hs-identifier hs-var">CacheMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Maybe CacheMap -&gt; Maybe CacheMap)
-&gt; DynamicName
-&gt; Map DynamicName CacheMap
-&gt; Map DynamicName CacheMap
forall k a.
Ord k =&gt;
(Maybe a -&gt; Maybe a) -&gt; k -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.alter</span></span><span> </span><span class="annot"><span class="annottext">Maybe CacheMap -&gt; Maybe CacheMap
</span><a href="#local-6989586621679540571"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">DynamicName
</span><a href="#local-6989586621679540577"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Map DynamicName CacheMap
</span><a href="#local-6989586621679540574"><span class="hs-identifier hs-var">sub</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map DynamicName Dynamic
</span><a href="#local-6989586621679540573"><span class="hs-identifier hs-var">vals</span></a></span><span>
</span><span id="line-73"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-74"></span><span>    </span><span id="local-6989586621679540571"><span class="annot"><span class="annottext">fn :: Maybe CacheMap -&gt; Maybe CacheMap
</span><a href="#local-6989586621679540571"><span class="hs-identifier hs-var hs-var">fn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CacheMap -&gt; Maybe CacheMap
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(CacheMap -&gt; Maybe CacheMap)
-&gt; (Maybe CacheMap -&gt; CacheMap) -&gt; Maybe CacheMap -&gt; Maybe CacheMap
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[DynamicName] -&gt; Dynamic -&gt; CacheMap -&gt; CacheMap
</span><a href="Reanimate.Memo.html#cacheMapInsert"><span class="hs-identifier hs-var">cacheMapInsert</span></a></span><span> </span><span class="annot"><span class="annottext">[DynamicName]
</span><a href="#local-6989586621679540576"><span class="hs-identifier hs-var">ks</span></a></span><span> </span><span class="annot"><span class="annottext">Dynamic
</span><a href="#local-6989586621679540575"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(CacheMap -&gt; CacheMap)
-&gt; (Maybe CacheMap -&gt; CacheMap) -&gt; Maybe CacheMap -&gt; CacheMap
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">CacheMap -&gt; Maybe CacheMap -&gt; CacheMap
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">CacheMap
</span><a href="Reanimate.Memo.html#emptyCacheMap"><span class="hs-identifier hs-var">emptyCacheMap</span></a></span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span class="hs-pragma">{-# NOINLINE</span><span> </span><span class="annot"><a href="Reanimate.Memo.html#cacheMap"><span class="hs-pragma hs-type">cacheMap</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-77"></span><span class="hs-comment">-- FIXME: There should be a way to clear the cache.</span><span>
</span><span id="line-78"></span><span class="annot"><a href="Reanimate.Memo.html#cacheMap"><span class="hs-identifier hs-type">cacheMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="annot"><a href="Reanimate.Memo.html#CacheMap"><span class="hs-identifier hs-type">CacheMap</span></a></span><span>
</span><span id="line-79"></span><span id="cacheMap"><span class="annot"><span class="annottext">cacheMap :: IORef CacheMap
</span><a href="Reanimate.Memo.html#cacheMap"><span class="hs-identifier hs-var hs-var">cacheMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO (IORef CacheMap) -&gt; IORef CacheMap
forall a. IO a -&gt; a
</span><span class="hs-identifier hs-var">unsafePerformIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CacheMap -&gt; IO (IORef CacheMap)
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">CacheMap
</span><a href="Reanimate.Memo.html#emptyCacheMap"><span class="hs-identifier hs-var">emptyCacheMap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span>
</span><span id="line-81"></span><span class="hs-comment">-- | Keys can either by any boxed object with identity (to be compared with</span><span>
</span><span id="line-82"></span><span class="hs-comment">--   StableNames) or a primitive type with an Eq instance.</span><span>
</span><span id="line-83"></span><span class="hs-keyword">data</span><span> </span><span id="Key"><span class="annot"><a href="Reanimate.Memo.html#Key"><span class="hs-identifier hs-var">Key</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679540568"><span class="annot"><a href="#local-6989586621679540568"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span id="Key"><span class="annot"><a href="Reanimate.Memo.html#Key"><span class="hs-identifier hs-var">Key</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621679540568"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679540566"><span class="annot"><a href="#local-6989586621679540566"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Typeable</span></span><span> </span><span class="annot"><a href="#local-6989586621679540566"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621679540566"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679540566"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span id="KeyPrim"><span class="annot"><a href="Reanimate.Memo.html#KeyPrim"><span class="hs-identifier hs-var">KeyPrim</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621679540566"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-84"></span><span>
</span><span id="line-85"></span><span class="annot"><a href="Reanimate.Memo.html#fromKey"><span class="hs-identifier hs-type">fromKey</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Reanimate.Memo.html#Key"><span class="hs-identifier hs-type">Key</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Reanimate.Memo.html#DynamicName"><span class="hs-identifier hs-type">DynamicName</span></a></span><span>
</span><span id="line-86"></span><span id="fromKey"><span class="annot"><span class="annottext">fromKey :: Key -&gt; IO DynamicName
</span><a href="Reanimate.Memo.html#fromKey"><span class="hs-identifier hs-var hs-var">fromKey</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Reanimate.Memo.html#Key"><span class="hs-identifier hs-type">Key</span></a></span><span> </span><span id="local-6989586621679540563"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679540563"><span class="hs-identifier hs-var">val</span></a></span></span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StableName a -&gt; DynamicName
forall a. StableName a -&gt; DynamicName
</span><a href="Reanimate.Memo.html#DynamicName"><span class="hs-identifier hs-var">DynamicName</span></a></span><span> </span><span class="annot"><span class="annottext">(StableName a -&gt; DynamicName)
-&gt; IO (StableName a) -&gt; IO DynamicName
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; IO (StableName a)
forall a. a -&gt; IO (StableName a)
</span><span class="hs-identifier hs-var">makeStableName</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679540563"><span class="hs-identifier hs-var">val</span></a></span><span>
</span><span id="line-87"></span><span class="annot"><a href="Reanimate.Memo.html#fromKey"><span class="hs-identifier hs-var">fromKey</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Reanimate.Memo.html#KeyPrim"><span class="hs-identifier hs-type">KeyPrim</span></a></span><span> </span><span id="local-6989586621679540561"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679540561"><span class="hs-identifier hs-var">val</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynamicName -&gt; IO DynamicName
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; DynamicName
forall a. (Eq a, Ord a, Typeable a) =&gt; a -&gt; DynamicName
</span><a href="Reanimate.Memo.html#DynamicKey"><span class="hs-identifier hs-var">DynamicKey</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679540561"><span class="hs-identifier hs-var">val</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span>
</span><span id="line-89"></span><span class="hs-comment">-- | Cache expensive value in global store. You must guarantee that the</span><span>
</span><span id="line-90"></span><span class="hs-comment">--   key uniquely determines the value.</span><span>
</span><span id="line-91"></span><span id="local-6989586621679540560"><span class="annot"><a href="Reanimate.Memo.html#memo"><span class="hs-identifier hs-type">memo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Typeable</span></span><span> </span><span class="annot"><a href="#local-6989586621679540560"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Reanimate.Memo.html#Key"><span class="hs-identifier hs-type">Key</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679540560"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679540560"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-92"></span><span id="memo"><span class="annot"><span class="annottext">memo :: [Key] -&gt; a -&gt; a
</span><a href="Reanimate.Memo.html#memo"><span class="hs-identifier hs-var hs-var">memo</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679540559"><span class="annot"><span class="annottext">[Key]
</span><a href="#local-6989586621679540559"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679540558"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679540558"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO a -&gt; a
forall a. IO a -&gt; a
</span><span class="hs-identifier hs-var">unsafePerformIO</span></span><span> </span><span class="annot"><span class="annottext">(IO a -&gt; a) -&gt; IO a -&gt; a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-93"></span><span>  </span><span id="local-6989586621679540557"><span class="annot"><span class="annottext">[DynamicName]
</span><a href="#local-6989586621679540557"><span class="hs-identifier hs-var">keys</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Key -&gt; IO DynamicName) -&gt; [Key] -&gt; IO [DynamicName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Key -&gt; IO DynamicName
</span><a href="Reanimate.Memo.html#fromKey"><span class="hs-identifier hs-var">fromKey</span></a></span><span> </span><span class="annot"><span class="annottext">[Key]
</span><a href="#local-6989586621679540559"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-94"></span><span>  </span><span class="annot"><span class="annottext">IORef CacheMap -&gt; (CacheMap -&gt; (CacheMap, a)) -&gt; IO a
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><span class="hs-identifier hs-var">atomicModifyIORef'</span></span><span> </span><span class="annot"><span class="annottext">IORef CacheMap
</span><a href="Reanimate.Memo.html#cacheMap"><span class="hs-identifier hs-var">cacheMap</span></a></span><span> </span><span class="annot"><span class="annottext">((CacheMap -&gt; (CacheMap, a)) -&gt; IO a)
-&gt; (CacheMap -&gt; (CacheMap, a)) -&gt; IO a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679540555"><span class="annot"><span class="annottext">CacheMap
</span><a href="#local-6989586621679540555"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-95"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Dynamic -&gt; Maybe a
forall a. Typeable a =&gt; Dynamic -&gt; Maybe a
</span><span class="hs-identifier hs-var">fromDynamic</span></span><span> </span><span class="annot"><span class="annottext">(Dynamic -&gt; Maybe a) -&gt; Maybe Dynamic -&gt; Maybe a
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">[DynamicName] -&gt; CacheMap -&gt; Maybe Dynamic
</span><a href="Reanimate.Memo.html#cacheMapLookup"><span class="hs-identifier hs-var">cacheMapLookup</span></a></span><span> </span><span class="annot"><span class="annottext">[DynamicName]
</span><a href="#local-6989586621679540557"><span class="hs-identifier hs-var">keys</span></a></span><span> </span><span class="annot"><span class="annottext">CacheMap
</span><a href="#local-6989586621679540555"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-96"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679540554"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679540554"><span class="hs-identifier hs-var">v'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CacheMap
</span><a href="#local-6989586621679540555"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679540554"><span class="hs-identifier hs-var">v'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span>      </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DynamicName] -&gt; Dynamic -&gt; CacheMap -&gt; CacheMap
</span><a href="Reanimate.Memo.html#cacheMapInsert"><span class="hs-identifier hs-var">cacheMapInsert</span></a></span><span> </span><span class="annot"><span class="annottext">[DynamicName]
</span><a href="#local-6989586621679540557"><span class="hs-identifier hs-var">keys</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Dynamic
forall a. Typeable a =&gt; a -&gt; Dynamic
</span><span class="hs-identifier hs-var">toDyn</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679540558"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CacheMap
</span><a href="#local-6989586621679540555"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679540558"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-98"></span></pre></body></html>